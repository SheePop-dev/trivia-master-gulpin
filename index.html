<!DOCTYPE html>
<html>
<style>
* {
  color: white;
  text-shadow: black 2px 2px;
  text-align: center;
  transition-duration: 0.5s;
  font-size: 120%;
}

button {
  background: none;
  cursor: pointer;
  padding: 10px;
  margin: 5px;
  border: 2px solid white;
  border-radius: 5px;
}

button:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.correct {
  background-color: rgba(0, 255, 0, 0.3);
}

.incorrect {
  background-color: rgba(255, 0, 0, 0.3);
}

</style>

<body>
  <div id="full">
    <h1 id="category">Category</h1>
    <p id="question">question</p>
    <div id="buttons">
      <button id="answer0" onClick="checkAnswer(0)">0</button>
      <button id="answer1" onClick="checkAnswer(1)">1</button>
      <button id="answer2" onClick="checkAnswer(2)">2</button>
      <button id="answer3" onClick="checkAnswer(3)">3</button>
    </buttons>
    <div id="punishment"></div>
    <div id="current-punishment" style="color:red; position: fixed; bottom: 0"></div>
    <img id="gulpin-yap" src="https://raw.githubusercontent.com/SheePop-dev/trivia-master-gulpin/refs/heads/main/gulpin-yap.gif">
  </div>
<script src="fanmade-questions.js"></script>
<script>
var punishments_totk = [
  "Drop all weapons", 
  "No armor until next question", 
  "Only move by jumping until the next question", 
  "Stop what you're doing and help a Korok", 
  "Stop what you're doing and complete a shrine", 
  
  "Speak Spanish until the next question", 
  "Echo mic until next question",
  "Stop what you're doing and draw a Tart Wars card", 
  "Nitro giveaway", 
  "Invert Switch colors", 
  
  "Block half the screen", 
  "Complete a race in Mario Kart",
  "Stop what you're doing and get a Bubbul Gem",
  "Stop what you're doing and pet a dog",
  "Stop what you're doing and defeat a miniboss",
  
  "Random Sporcle quiz until you get at least 75%",
  "Do the VGBandle",
  "Draw a random pokemon from memory",
  "Chance of gulpin replacing words increased by 10%",
  "Say a curse word",
  
  "Do the Wordle",
  "Do the Globle",
  "Do a Random Battle in Pokemon Showdown",
  "Do a Dutch Duolingo lesson",
  "Do a GBL battle in Pokemon Go",
  
  "Catch a fish",
  "Open a Tart Wars pack",
  "Battle Relicanth in SheePop vs Zarel",
  "Do the PokeRap",
  "Go to the Depths until the next question",
  
  "Do the PokeDoku",
  "Do the Gamedle",
  "Recite Steamed Hams from memory",
  "Give chat a shiny Pokemon"
  
];

const originalPunishments = [...punishments_totk];

var questionNumber = 4;
var fanQuestionNumber = 0;
var gulpinChance = .15;

speakText(0, "It's Question Time!");
let correctAnswer = "";

let res;
let data;
let q;
let category = "";
let question = "";
let correct_answer = "";
let all_answers = [];

let currPunishment = "";

function getBestVoice() {
  const voices = speechSynthesis.getVoices();
  const englishVoice = voices.find(v => v.lang.startsWith('en'));
  return englishVoice || voices[0];
}

if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = () => {};
}

async function loadQuestion() {
  questionNumber++;
  currPunishment = "";
  document.getElementById("answer0").style.display = "inline";
  document.getElementById("answer1").style.display = "inline";
  document.getElementById("answer2").style.display = "inline";
  document.getElementById("answer3").style.display = "inline";
  
  for(let i = 0; i < 4; i++) {
    document.getElementById("answer" + i).classList.remove("correct", "incorrect");
    document.getElementById("answer" + i).disabled = false;
  }
  
  document.getElementById("full").style.opacity = "1";
  document.getElementById("question").innerHTML = "";
  document.getElementById("punishment").innerHTML = "";
  document.getElementById("current-punishment").innerHTML = "";
  
  if (questionNumber < 4) {
    try {
      res = await fetch("https://opentdb.com/api.php?amount=1&type=multiple");
      if (!res.ok) {
        throw new Error('Failed to fetch question from API');
      }
      data = await res.json();
      q = data.results[0];
      category = decode(q.category);
      question = decode(q.question);
      correct_answer = decode(q.correct_answer);
      correctAnswer = correct_answer;
      all_answers = q.incorrect_answers.map(a => decode(a));
      all_answers.push(correct_answer);
    } catch (error) {
      console.error('Error loading question:', error);
      questionNumber = 4;
      await loadQuestion();
      return;
    }
  } else {
    if (fanQuestionNumber >= fanmadeQuestionArray.length) {
      fanQuestionNumber = 0;
      fanmadeQuestionArray = shuffle([...fanmadeQuestionArray]);
    }
    
    category = fanmadeQuestionArray[fanQuestionNumber][0];
    question = fanmadeQuestionArray[fanQuestionNumber][1];
    correctAnswer = fanmadeQuestionArray[fanQuestionNumber][2];
    all_answers = [ 
      fanmadeQuestionArray[fanQuestionNumber][2], 
      fanmadeQuestionArray[fanQuestionNumber][3], 
      fanmadeQuestionArray[fanQuestionNumber][4], 
      fanmadeQuestionArray[fanQuestionNumber][5] 
    ];
    fanQuestionNumber++;
    questionNumber = 0;
  }
  
  all_answers = shuffle(all_answers);
  speakText(0, "The category is " + category);
  document.getElementById("category").innerHTML = category;
  const questionWordsArray = question.split(" ");
  var i = 0;
  var gulpinQuestion = "";
  for(i=0;i<questionWordsArray.length;i++) {
    if (Math.random() <= gulpinChance) {
      questionWordsArray[i] = "GULPIN";
    }
    gulpinQuestion += questionWordsArray[i] + " ";
  }
  speakText(1, gulpinQuestion);
  for(i=0;i<4;i++) {
    document.getElementById("answer" + i).innerHTML = all_answers[i];
  }   
}

function checkAnswer(int) {
  for(let i = 0; i < 4; i++) {
    document.getElementById("answer" + i).disabled = true;
  }
  
  const selectedAnswer = document.getElementById("answer" + int).innerHTML;
  let result = "";
  
  for(let i = 0; i < 4; i++) {
    if (document.getElementById("answer" + i).innerHTML === correctAnswer) {
      document.getElementById("answer" + i).classList.add("correct");
    }
  }
  
  if (selectedAnswer == correctAnswer) {
    result = "That's correct! You're safe. For now."
    playSound("https://github.com/SheePop-dev/trivia-master-gulpin/blob/main/correct.mp3?raw=true");
  } else {
    document.getElementById("answer" + int).classList.add("incorrect");
    
    if (punishments_totk.length === 0) {
      punishments_totk = [...originalPunishments];
    }
    
    var rando = Math.floor(Math.random() * punishments_totk.length);
    currPunishment = punishments_totk[rando];
    result = "WRONG! The correct answer was " + correctAnswer;
    punishments_totk.splice(rando, 1);
    playSound("https://github.com/SheePop-dev/trivia-master-gulpin/blob/main/incorrect.mp3?raw=true");
    
    if (currPunishment == "Chance of gulpin replacing words increased by 10%") {
      gulpinChance += .1;
    }
  }
  document.getElementById("punishment").innerHTML = result;
  document.getElementById("question").innerHTML = " ";
  document.getElementById("category").innerHTML = " ";
  document.getElementById("answer0").style.display = "none";
  document.getElementById("answer1").style.display = "none";
  document.getElementById("answer2").style.display = "none";
  document.getElementById("answer3").style.display = "none";
  speakText(0, result);
  if (result != "That's correct! You're safe. For now.") {
    speakText(0, ". Your punishment is: " + currPunishment);
  }
  setTimeout(function() {
    document.getElementById("punishment").innerHTML = "";
    if (result != "That's correct! You're safe. For now.") {
      document.getElementById("current-punishment").innerHTML = "Current punishment: " + currPunishment;
    }
  }, 5000);
}

function decode(val) {
  const text = document.createElement("textarea");
  text.innerHTML = val;
  return text.value;
}

function shuffle(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
   }
  return shuffled;
}

function playSound(url) {
  return new Promise(resolve => {
    const audio = new Audio(url);
    audio.onended = resolve;
    audio.onerror = resolve;
    audio.play().catch(resolve);
  });
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function speakText(val, sentence) {
  const keyword = "GULPIN";
  const audio = new Audio("https://play.pokemonshowdown.com/audio/cries/gulpin.mp3");
  const parts = sentence.split(keyword);
  let i = 0;
  function next() {
    if (i >= parts.length) return;
    const text = parts[i].trim();
    const utter = new SpeechSynthesisUtterance(text);
    const voice = getBestVoice();
    if (voice) {
      utter.voice = voice;
    }
    if (val == 1) {
      document.getElementById("question").innerHTML += text + " ";
    }
    utter.onstart = () => {
      document.getElementById("gulpin-yap").style.opacity = "1";
    };
    
    utter.onend = () => {
      i++;
      if (i < parts.length) {
        audio.onended = next;
        document.getElementById("question").innerHTML += "GULPIN ";
        audio.play();
      } else {
        document.getElementById("gulpin-yap").style.opacity = "0";
      }
    };
    speechSynthesis.speak(utter);
  }
  next();
}

loadQuestion();
setInterval(function() {
  loadQuestion();
}, 420000);

</script>
</body>
</html>
