<!DOCTYPE html>
<html>
<style>
* {
  color: white;
  text-shadow: black 2px 2px;
  text-align: center;
  transition-duration: 0.5s;
  font-size: 120%;
}

button {
  background: none;
  cursor: pointer;
  padding: 10px;
  margin: 5px;
  border: 2px solid white;
  border-radius: 5px;
}

button:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.correct {
  background-color: rgba(0, 255, 0, 0.3);
}

.incorrect {
  background-color: rgba(255, 0, 0, 0.3);
}
</style>

<body>
  <div id="full">
    <h1 id="category">Category</h1>
    <p id="question">question</p>
    <div id="buttons">
      <button id="answer0" onClick="checkAnswer(0)">0</button>
      <button id="answer1" onClick="checkAnswer(1)">1</button>
      <button id="answer2" onClick="checkAnswer(2)">2</button>
      <button id="answer3" onClick="checkAnswer(3)">3</button>
    </div>
    <div id="punishment"></div>
    <div id="current-punishment" style="color:red; position: fixed; bottom: 0"></div>
    <img id="gulpin-yap" src="https://raw.githubusercontent.com/SheePop-dev/trivia-master-gulpin/refs/heads/main/gulpin-yap.gif">
  </div>
<script src="fanmade-questions.js"></script>
<script>
let punishments = [
  "Drop all weapons", 
  "No armor until next question", 
  "Only move by jumping until the next question", 
  "Stop what you're doing and help a Korok", 
  "Stop what you're doing and complete a shrine", 
  "Speak Spanish until the next question", 
  "Echo mic until next question",
  "Stop what you're doing and draw a Tart Wars card", 
  "Nitro giveaway", 
  "Invert Switch colors", 
  "Block half the screen", 
  "Complete a race in Mario Kart",
  "Stop what you're doing and get a Bubbul Gem",
  "Stop what you're doing and pet a dog",
  "Stop what you're doing and defeat a miniboss",
  "Random Sporcle quiz until you get at least 75%",
  "Do the VGBandle",
  "Draw a random pokemon from memory",
  "Chance of gulpin replacing words increased by 10%",
  "Say a curse word",
  "Do the Wordle",
  "Do the Globle",
  "Do a Random Battle in Pokemon Showdown",
  "Do a Dutch Duolingo lesson",
  "Do a GBL battle in Pokemon Go",
  "Catch a fish",
  "Open a Tart Wars pack",
  "Battle Relicanth in SheePop vs Zarel",
  "Do the PokeRap",
  "Go to the Depths until the next question",
  "Do the PokeDoku",
  "Do the Gamedle",
  "Recite Steamed Hams from memory",
  "Give chat a shiny Pokemon"
];

const originalPunishments = [...punishments];

const API_QUESTION_CYCLE = 4;
const QUESTION_INTERVAL_MS = 420000;
const BASE_GULPIN_CHANCE = 0.15;

let questionNumber = API_QUESTION_CYCLE;
let fanQuestionNumber = 0;
let gulpinChance = BASE_GULPIN_CHANCE;
let correctAnswer = "";
let currentPunishment = "";
let currentQuestion = { category: "", question: "", answers: [] };

const elements = {
  category: document.getElementById("category"),
  question: document.getElementById("question"),
  punishment: document.getElementById("punishment"),
  currentPunishment: document.getElementById("current-punishment"),
  gulpinYap: document.getElementById("gulpin-yap"),
  answers: [0, 1, 2, 3].map(i => document.getElementById("answer" + i)),
  full: document.getElementById("full")
};

speakText(0, "It's Question Time!");

function getBestVoice() {
  const voices = speechSynthesis.getVoices();
  return voices.find(v => v.lang.startsWith('en')) || voices[0];
}

if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = () => {};
}

async function loadQuestion() {
  questionNumber++;
  currentPunishment = "";
  
  elements.answers.forEach(btn => {
    btn.style.display = "inline";
    btn.classList.remove("correct", "incorrect");
    btn.disabled = false;
  });
  
  elements.full.style.opacity = "1";
  elements.question.innerHTML = "";
  elements.punishment.innerHTML = "";
  elements.currentPunishment.innerHTML = "";
  
  let category, question, answers;
  
  if (questionNumber < API_QUESTION_CYCLE) {
    try {
      const res = await fetch("https://opentdb.com/api.php?amount=1&type=multiple");
      if (!res.ok) throw new Error('API fetch failed');
      const data = await res.json();
      const q = data.results[0];
      category = decode(q.category);
      question = decode(q.question);
      correctAnswer = decode(q.correct_answer);
      answers = [...q.incorrect_answers.map(decode), correctAnswer];
    } catch (error) {
      console.error('Error loading question:', error);
      questionNumber = API_QUESTION_CYCLE;
      return loadQuestion();
    }
  } else {
    if (fanQuestionNumber >= fanmadeQuestionArray.length) {
      fanQuestionNumber = 0;
      fanmadeQuestionArray = shuffle([...fanmadeQuestionArray]);
    }
    
    const q = fanmadeQuestionArray[fanQuestionNumber];
    category = q[0];
    question = q[1];
    correctAnswer = q[2];
    answers = q.slice(2, 6);
    fanQuestionNumber++;
    questionNumber = 0;
  }
  
  answers = shuffle(answers);
  speakText(0, "The category is " + category);
  elements.category.innerHTML = category;
  
  const gulpinQuestion = question.split(" ")
    .map(word => Math.random() <= gulpinChance ? "GULPIN" : word)
    .join(" ");
  
  speakText(1, gulpinQuestion);
  elements.answers.forEach((btn, i) => btn.innerHTML = answers[i]);   
}

function checkAnswer(index) {
  const CORRECT_MSG = "That's correct! You're safe. For now.";
  
  elements.answers.forEach(btn => btn.disabled = true);
  const selectedAnswer = elements.answers[index].innerHTML;
  
  elements.answers.forEach(btn => {
    if (btn.innerHTML === correctAnswer) btn.classList.add("correct");
  });
  
  let result;
  if (selectedAnswer === correctAnswer) {
    result = CORRECT_MSG;
    playSound("https://github.com/SheePop-dev/trivia-master-gulpin/blob/main/correct.mp3?raw=true");
  } else {
    elements.answers[index].classList.add("incorrect");
    
    if (punishments.length === 0) punishments = [...originalPunishments];
    
    const randomIndex = Math.floor(Math.random() * punishments.length);
    currentPunishment = punishments.splice(randomIndex, 1)[0];
    result = "WRONG! The correct answer was " + correctAnswer;
    playSound("https://github.com/SheePop-dev/trivia-master-gulpin/blob/main/incorrect.mp3?raw=true");
    
    if (currentPunishment === "Chance of gulpin replacing words increased by 10%") {
      gulpinChance += 0.1;
    }
  }
  
  elements.punishment.innerHTML = result;
  elements.question.innerHTML = " ";
  elements.category.innerHTML = " ";
  elements.answers.forEach(btn => btn.style.display = "none");
  
  speakText(0, result);
  if (result !== CORRECT_MSG) {
    speakText(0, ". Your punishment is: " + currentPunishment);
  }
  
  setTimeout(() => {
    elements.punishment.innerHTML = "";
    if (result !== CORRECT_MSG) {
      elements.currentPunishment.innerHTML = "Current punishment: " + currentPunishment;
    }
  }, 5000);
}

function decode(html) {
  const textarea = document.createElement("textarea");
  textarea.innerHTML = html;
  return textarea.value;
}

function shuffle(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function playSound(url) {
  return new Promise(resolve => {
    const audio = new Audio(url);
    audio.onended = resolve;
    audio.onerror = resolve;
    audio.play().catch(resolve);
  });
}

function speakText(showOnScreen, sentence) {
  const GULPIN_CRY = new Audio("https://play.pokemonshowdown.com/audio/cries/gulpin.mp3");
  const parts = sentence.split("GULPIN");
  let partIndex = 0;
  
  function speakNextPart() {
    if (partIndex >= parts.length) return;
    
    const text = parts[partIndex].trim();
    const utterance = new SpeechSynthesisUtterance(text);
    const voice = getBestVoice();
    if (voice) utterance.voice = voice;
    
    if (showOnScreen === 1) {
      elements.question.innerHTML += text + " ";
    }
    
    utterance.onstart = () => elements.gulpinYap.style.opacity = "1";
    utterance.onend = () => {
      partIndex++;
      if (partIndex < parts.length) {
        GULPIN_CRY.onended = speakNextPart;
        elements.question.innerHTML += "GULPIN ";
        GULPIN_CRY.play();
      } else {
        elements.gulpinYap.style.opacity = "0";
      }
    };
    
    speechSynthesis.speak(utterance);
  }
  
  speakNextPart();
}

loadQuestion();
setInterval(loadQuestion, QUESTION_INTERVAL_MS);

</script>
</body>
</html>